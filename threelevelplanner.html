
<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Three Level Planner</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <style type="text/css">
      @import url(http://fonts.googleapis.com/css?family=Droid+Serif);
      @import url(http://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(http://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      #threelevel {
        width: 90%;
        height: 90vh;
      }

      #threeleveldiv {
        flex: 3 0 0px;
        overflow: hidden;
        align-items: center;
        justify-content: center;
        align-self: center;

        display: flex;
        flex-direction: column;
      }

      #timediv {
        flex: 1 0 0px;

        display: flex;
        flex-direction: column;
      }

      #settingsdiv {
        flex: 0.5 0 0px;
        overflow: hidden;

        display: flex;
        flex-direction: column;
      }

      #content {
        display: flex;
      }
    </style>
  </head>
  <body>
    <script type="text/javascript">
$( document ).ready(function() {
  loadFile();

  $('#threelevel').keyup(function() {
    showTime();
  });

  $('#threelevel').change(function() {
    showTime();
  });
});


function loadFile() {
  $.get( "/classes/SVDA/three_level.txt", function( data ) {
    $( "#threelevel" ).text( data );
    
    showTime();
  });
}

function showTime() {
  var slidesPerHour = parseInt($( "#slidesperhour" ).val())
  var hoursPerDay = parseInt($( "#hoursperday" ).val())
  var demoMultiplier = parseInt($( "#demomultiplier" ).val())
  var exerciseMultiplier = parseInt($( "#exercisemultiplier" ).val())

  allLines = $( "#threelevel" ).val().split("\n")

  $( "#time" ).html("")
  
  var chapters = -1;
  var sections = 0;
  var regular = 0;
  var demoMinutes = 0;
  var exerciseMinutes = 0;

  var currentSlides = 0;
  var currentDemoMinutes = 0;
  var currentExerciseMinutes = 0;
  var currentChapterName = ""

  var m;
  var demoRE = /#demo\s+(\d+)/;
  var exerciseRE = /#exercise\s+(\d+)/;
  
  var sectionNoSlides = /\s{2}(.*)/;
  var sectionWithSlides = /\s{2}(.*) (\d+)/;

  chapterTimes = new Map()
  chapterTimes["chapters"] = []

  for (var i = 0; i < allLines.length; i++) {
    // Process regular slides
    if (allLines[i].startsWith("    ")) {
      if ((m = demoRE.exec(allLines[i])) !== null) {
        var minutes = parseInt(m[1]) * demoMultiplier
        demoMinutes += minutes;
        currentDemoMinutes += minutes;
      } else if ((m = exerciseRE.exec(allLines[i])) !== null) {
        var minutes = parseInt(m[1]) * exerciseMultiplier
        exerciseMinutes += minutes;
        currentExerciseMinutes += minutes;
      } else {
        regular++;
        currentSlides++;
      }
    // Process sections
    } else if ((m = sectionWithSlides.exec(allLines[i])) !== null) {
      sections++;

      if(typeof m[2] !== 'undefined'){
        // If the section has a slide count, use it
        sectionSlides = parseInt(m[2])
        regular += sectionSlides
        currentSlides += sectionSlides
      }
    } else if ((m = sectionNoSlides.exec(allLines[i])) !== null) {
      sections++;
    // Process chapters
    } else {
      chapters++;

      if (chapters != 0) {
        chapterTimes["chapters"].push(this.outputChapterTime(regular, demoMinutes, exerciseMinutes, slidesPerHour, chapters, currentChapterName, currentSlides, currentExerciseMinutes, currentDemoMinutes, hoursPerDay))

        currentSlides = 0;
        currentExerciseMinutes = 0;
        currentDemoMinutes = 0;
      }

      currentChapterName = allLines[i];
    }
  }

  chapterTimes["chapters"].push(outputChapterTime(regular, demoMinutes, exerciseMinutes, slidesPerHour, chapters, currentChapterName, currentSlides, currentExerciseMinutes, currentDemoMinutes, hoursPerDay))

  chapterTimes["total"] = {
    "totalchapters": chapters,
    "totalsections": sections,
    "totalregular": regular,
    "totaldemos": demoMinutes,
    "totalexercises": exerciseMinutes,
    "slidesperhour": slidesPerHour
  }

  displayChapters(chapterTimes)
}

function displayChapters(chapterTimes) {
  html = ""

  for (var i = 0; i < chapterTimes["chapters"].length; i++) {
    html += chapterTimes["chapters"][i]["overallruntime"] + " " + chapterTimes["chapters"][i]["chaptername"] + " " + chapterTimes["chapters"][i]["chapterslides"] + "<br>"
  }

  slidesPerMinute = 60 / chapterTimes["total"]["slidesperhour"]
  totalSlideTime = chapterTimes["total"]["totalregular"] * slidesPerMinute
  totalCourseTime = totalSlideTime + chapterTimes["total"]["totaldemos"] + chapterTimes["total"]["totalexercises"]

  html += "<br><br>Total times in minutes:<br>"
  html += "<table>"

  html += "<tr><td>Total Time</td><td>" + totalCourseTime.toFixed(2) + "</td></tr>"
  html += "<tr><td>Total Slides</td><td>" + chapterTimes["total"]["totalregular"] + "</td></tr>"
  html += "<tr><td>Total Slide Time</td><td>" + totalSlideTime.toFixed(2) + "</td></tr>"
  html += "<tr><td>Total Demos</td><td>" + chapterTimes["total"]["totaldemos"] + "</td></tr>"
  html += "<tr><td>Total Exercises</td><td>" + chapterTimes["total"]["totalexercises"] + "</td></tr>"

  html += "</table>"

  html += "<br><br>" + (((chapterTimes["total"]["totaldemos"] + chapterTimes["total"]["totalexercises"]) / totalCourseTime) * 100).toFixed(1) + "% of class time is exercises/demos"

  $("#time").html(html)
}

function outputChapterTime(regular, demoMinutes, exerciseMinutes, slidesPerHour, chapters, currentChapterName, currentSlides, currentExerciseMinutes, currentDemoMinutes, hoursPerDay) {
  chapterMap = {
    "overallruntime": this.calculateTime(regular, demoMinutes, exerciseMinutes, slidesPerHour, hoursPerDay),
    "chapter": chapters,
    "chaptername": currentChapterName,
    "chapterslides": currentSlides,
    "chapterexerciseminutes": currentExerciseMinutes,
    "chapterdemominutes": currentDemoMinutes,
    "chaptertotaltime": ((currentSlides * (60 / slidesPerHour)) + currentExerciseMinutes + currentDemoMinutes).toFixed(0)
  }

  return chapterMap
}

// Calculates the current run time
function calculateTime(slides, demo, exercise, slidesPerHour) {
  var totalMinutes = ((slides / slidesPerHour) * 60) + demo + exercise
  var hoursPerDay = 4.0

  var days = Math.ceil(totalMinutes / (60 * hoursPerDay))

  var hours = (totalMinutes - ((days - 1) * hoursPerDay * 60)) / 60

  return "Day " + days + " " + hours.toFixed(2) + " hours"
}



    </script>
    
    <div id="content">
      <div id="threeleveldiv">
        Three Level:
        <textarea id="threelevel">Text</textarea>
      </div>

      <div id="timediv">
        Chapter Times:
        <div id="time"></div>
      </div>

      <div id="settingsdiv">
        Settings:<br>
        Hours Per Day:
        <input id="hoursperday" type="text" value="6.5">

        Slides Per Hour:
        <input id="slidesperhour" type="text" value="21">

        Demo Multiplier:
        <input id="demomultiplier" type="text" value="1">

        Exercise Multiplier:
        <input id="exercisemultiplier" type="text" value="1">
      </div>
    </div>
  </body>
</html>
